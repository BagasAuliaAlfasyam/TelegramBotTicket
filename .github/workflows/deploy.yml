# ============================================================
# Deploy â€” Build images via Cloud Build, deploy to GCP VM
# ============================================================
# Triggers on push to main branch only.
#
# Required GitHub Secrets:
#   GCP_SA_KEY          â€” Service account JSON key (base64)
#   GCP_PROJECT_ID      â€” GCP project ID (mytech-480618)
#   GCP_VM_NAME         â€” VM instance name (mytechops)
#   GCP_VM_ZONE         â€” VM zone (asia-southeast2-a)
#   GCP_VM_USER         â€” SSH user on VM (bagas)
# ============================================================
name: Deploy

on:
  push:
    branches: [main]
    paths-ignore:
      - "**.md"
      - ".gitignore"
      - "LICENSE"

  # Allow manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      skip_build:
        description: "Skip Cloud Build (deploy existing latest)"
        type: boolean
        default: false

env:
  REGION: asia-southeast2
  REGISTRY: asia-southeast2-docker.pkg.dev
  REPO: microservices
  IMAGE_TAG: ${{ github.sha }}
  GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_VM_NAME: ${{ secrets.GCP_VM_NAME }}
  GCP_VM_ZONE: ${{ secrets.GCP_VM_ZONE }}
  GCP_VM_USER: ${{ secrets.GCP_VM_USER }}

jobs:
  # â”€â”€ Job 1: Build images via Cloud Build â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: Build & Push Images
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_build }}
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ env.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Submit to Cloud Build
        run: |
          gcloud builds submit \
            --project=${{ env.GCP_PROJECT_ID }} \
            --config=cloudbuild.yaml \
            --substitutions=_IMAGE_TAG=${{ env.IMAGE_TAG }}

      - name: Summary
        run: |
          echo "### âœ… Images built & pushed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Image | Tag |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-----|" >> $GITHUB_STEP_SUMMARY
          for svc in prediction-api training-api data-api collector-bot admin-bot; do
            echo "| \`$svc\` | \`${{ env.IMAGE_TAG }}\` |" >> $GITHUB_STEP_SUMMARY
          done

  # â”€â”€ Job 2: Deploy to VM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    name: Deploy to VM
    runs-on: ubuntu-latest
    needs: [build]
    if: always() && (needs.build.result == 'success' || inputs.skip_build)

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ env.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker auth on VM
        run: |
          gcloud compute ssh ${{ env.GCP_VM_USER }}@${{ env.GCP_VM_NAME }} \
            --zone=${{ env.GCP_VM_ZONE }} \
            --quiet \
            --command="gcloud auth configure-docker ${{ env.REGISTRY }} --quiet 2>/dev/null || true"

      - name: Deploy to VM
        run: |
          gcloud compute ssh ${{ env.GCP_VM_USER }}@${{ env.GCP_VM_NAME }} \
            --zone=${{ env.GCP_VM_ZONE }} \
            --quiet \
            --command="
              cd ~/TelegramBotMyTech

              # Pull latest code (for compose files, configs)
              git pull origin main --ff-only

              # Set image registry
              export IMAGE_REGISTRY=${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.REPO }}/
              export IMAGE_TAG=${{ env.IMAGE_TAG }}

              # Pull pre-built images
              docker compose \
                -f docker-compose.microservices.yml \
                -f docker-compose.prod.yml \
                --env-file .env.local \
                pull prediction-api training-api data-api collector-bot admin-bot

              # Deploy (only recreates changed services)
              docker compose \
                -f docker-compose.microservices.yml \
                -f docker-compose.prod.yml \
                --env-file .env.local \
                up -d --no-build

              # Wait for health checks
              sleep 15
              echo '--- Container Status ---'
              docker ps --format 'table {{.Names}}\t{{.Status}}'

              # Quick health check
              for port in 8001 8002 8005; do
                status=\$(curl -s -o /dev/null -w '%{http_code}' http://localhost:\$port/health || echo '000')
                echo \"Port \$port: HTTP \$status\"
              done
            "

      - name: Deploy summary
        if: success()
        run: |
          echo "### ðŸš€ Deployed to VM" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **VM**: ${{ env.GCP_VM_NAME }} (${{ env.GCP_VM_ZONE }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Image tag**: \`${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY

  # â”€â”€ Job 3: Post-deploy validation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  validate:
    name: Validate Deployment
    runs-on: ubuntu-latest
    needs: [deploy]
    if: success()

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ env.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Health checks
        run: |
          gcloud compute ssh ${{ env.GCP_VM_USER }}@${{ env.GCP_VM_NAME }} \
            --zone=${{ env.GCP_VM_ZONE }} \
            --quiet \
            --command="
              echo '=== Service Health ==='
              failed=0
              for svc in prediction-api:8001 data-api:8002 training-api:8005; do
                name=\${svc%%:*}
                port=\${svc##*:}
                resp=\$(curl -sf http://localhost:\$port/health 2>/dev/null)
                if [ \$? -eq 0 ]; then
                  echo \"âœ“ \$name â€” healthy\"
                else
                  echo \"âœ— \$name â€” UNHEALTHY\"
                  failed=1
                fi
              done
              
              echo ''
              echo '=== Container Status ==='
              docker ps --format 'table {{.Names}}\t{{.Status}}'
              
              exit \$failed
            "

      - name: Validation summary
        if: success()
        run: |
          echo "### âœ… All services healthy" >> $GITHUB_STEP_SUMMARY
